#include <SiroSpectrum/core.h>
#include <SiroSpectrum/game.h>
#include <stdio.h>

//typedef struct Tile {
//	unsigned char canvas[8 * 8];
//	unsigned char colour;
//}Tile;

unsigned char stefanvas[8 * 16] = {
	0,0,0,1,1,1,0,0,
	0,0,1,1,1,1,1,0,
	0,1,1,1,1,1,0,0,
	0,1,1,1,0,1,0,0,
	0,1,1,1,1,1,1,0,
	0,0,1,1,1,1,0,0,
	0,0,0,1,1,0,0,0,
	0,0,1,0,0,1,0,0,
	0,1,1,1,1,1,0,0,
	0,1,0,1,1,1,0,0,
	0,0,0,1,1,1,0,0,
	0,1,0,0,0,0,1,0,
	0,0,1,1,1,1,0,0,
	0,0,1,1,0,1,0,0,
	0,0,1,0,1,1,0,0,
	0,0,1,1,0,1,1,0,
};

unsigned char stefanvas1[8 * 16] = {
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,0,1,0,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,
0,0,1,0,0,1,0,0,
0,1,1,1,1,1,0,0,
0,1,0,1,1,1,0,0,
0,1,0,1,1,1,0,0,
0,0,1,0,0,0,0,0,
0,0,0,1,1,1,0,0,
0,0,1,1,0,1,0,0,
0,0,1,0,1,0,0,0,
0,0,0,1,0,1,0,0,
};

unsigned char stefanvas2[8 * 16] = {
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,1,0,
0,1,1,1,1,1,1,0,
0,1,1,1,0,1,0,0,
0,1,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,
0,0,1,0,0,1,0,0,
0,1,1,1,1,1,1,0,
1,0,0,1,1,1,1,0,
0,0,1,1,1,1,0,1,
1,0,0,0,0,0,0,0,
0,0,1,1,1,1,0,0,
0,1,1,1,0,1,1,0,
1,1,0,0,0,1,1,1,
0,1,1,0,0,0,1,0,
};

unsigned char wall[8 * 8] = {
	0,1,0,0,0,0,0,0,
	0,1,0,0,0,0,0,0,
	1,1,1,1,1,1,1,1,
	0,0,0,0,0,1,0,0,
	0,0,0,0,0,1,0,0,
	0,0,0,0,0,1,0,0,
	1,1,1,1,1,1,1,1,
	0,1,0,0,0,0,0,0,
};


unsigned char map[32 * 24] = {
	1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
	1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
	1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,
};
unsigned char cat[] = {
	1,0,0,0,1,0,0,1,
	1,0,0,0,1,1,1,1,
	1,1,0,0,1,0,1,0,
	0,1,1,1,1,1,1,1,
	0,0,1,1,1,1,1,0,
	0,0,1,0,1,0,1,0,
};
Tile Air = { {
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,}, 0b00000000 };

Tile Wall = { {
	0,1,0,0,0,0,0,0,
	0,1,0,0,0,0,0,0,
	1,1,1,1,1,1,1,1,
	0,0,0,0,0,1,0,0,
	0,0,0,0,0,1,0,0,
	0,0,0,0,0,1,0,0,
	1,1,1,1,1,1,1,1,
	0,1,0,0,0,0,0,0,}, 0b00100001 };

Sprite Stefan = {stefanvas, 8, 16};
Sprite Stefan1 = {stefanvas1, 8, 16};
Sprite Stefan2 = {stefanvas2, 8, 16};
Sprite downey = { cat, 8, 6 };
Tile tiles[2];
Sprite stef_walk[4];
Game* scenes[2];

unsigned char plr_x = 0;
unsigned char plr_y = 0;
unsigned char dir = 0b0001000;
unsigned char frame = 0;
unsigned char gamenum = 0;

void UpdateFrame(void) {
	frame = frame + 1 & 3;
}

TimeEvent frameupdate = { 8, UpdateFrame};

void setup() {
	plr_x = 100;
	plr_y = 100;
	frame = 0;
	tiles[0] = Air;
	tiles[1] = Wall;
	stef_walk[0] = Stefan;
	stef_walk[1] = Stefan1;
	stef_walk[2] = Stefan2;
	stef_walk[3] = Stefan1;
	unsigned short sum = 0;
	for (int y = 0; y < 24; y++) {
		for (int x = 0; x < 32; x++) {
			SetTile(tiles[map[sum]], x, y);
			sum++;
		}
	}
}

void UpdatePlayer() {
	RemoveSprite(Stefan, plr_x, plr_y);

	plr_x += 2 * GetKey(Right);
	plr_x -= 2 * GetKey(Left);
	plr_y += 2 * GetKey(Down);
	plr_y -= 2 * GetKey(Up);

	if (GetKey(Right) || GetKey(Left) || GetKey(Up) || GetKey(Down)) {
		RunTimeEvent(&frameupdate);

		dir |= GetKey(Left) * 16;
		dir &= ~(16) * ~GetKey(Right);
	}
	SetSprite(stef_walk[frame], plr_x, plr_y, dir | 8);
}

void loop() {
	UpdatePlayer();
	if (GetKeyPressed(Escape)) {
		gamenum++;
		gamenum &= 1;
		ResetWindow();
	}
	SetSprite(downey, 128, 100, 7);
}

void setuptoo() {
	SetPixel(4, 4, 5);
}

void looptoo() {
	if (GetKeyPressed(Escape)) {
		gamenum++;
		gamenum &= 1;
		ResetWindow();
	}
}

int main(void) {
	Game* fungame = newGame(setup, loop);
	Game* stupidgame = newGame(setuptoo, looptoo);

	scenes[0] = fungame;
	scenes[1] = stupidgame;

	CreateWindow();

	while (!CloseWindow()) {
		RunGame(scenes[gamenum]);
	}


	return 0;
}