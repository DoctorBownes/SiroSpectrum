#include <SiroSpectrum/core.h>
#include <SiroSpectrum/game.h>
#include <TEMPTARE/entity.h>
#include <stdio.h>

//typedef struct Tile {
//	unsigned char canvas[8 * 8];
//	unsigned char colour;
//}Tile;

unsigned char stefanvas[8 * 16] = { 
0,0,0,1,1,1,0,0,
0,0,1,1,1,1,1,0,
0,1,1,1,1,1,0,0,
0,1,1,1,0,1,0,0,
0,0,1,1,1,1,1,0,
0,0,1,1,1,1,0,0,
0,0,0,1,1,0,0,0,
0,0,1,1,0,1,0,0,
0,1,1,1,0,1,1,0,
0,1,1,1,0,1,1,0,
0,1,1,1,1,1,1,0,
0,1,0,0,1,0,1,0,
0,0,1,1,1,1,0,0,
0,0,1,1,0,1,0,0,
0,0,1,0,1,1,0,0,
0,0,1,1,0,1,1,0,
};

unsigned char wall[8 * 8] = {
	0,1,0,0,0,0,0,0,
	0,1,0,0,0,0,0,0,
	1,1,1,1,1,1,1,1,
	0,0,0,0,0,1,0,0,
	0,0,0,0,0,1,0,0,
	0,0,0,0,0,1,0,0,
	1,1,1,1,1,1,1,1,
	0,1,0,0,0,0,0,0,
};


unsigned char* map;
unsigned char father[] = { 
	0,0,0,0,0,0,0,0,
	0,0,1,1,1,0,0,0,
	0,1,1,1,1,1,0,0,
	0,1,1,1,0,1,0,0,
	0,1,1,1,1,1,1,0,
	0,0,1,1,1,1,0,0,
	0,0,0,1,1,0,0,0,
	0,1,1,1,1,1,1,0,
	0,0,1,1,0,1,0,0,
	1,0,1,0,0,0,0,1,
	1,0,1,1,0,1,0,1,
	1,0,1,1,0,1,0,1,
	1,0,1,1,1,1,0,1,
	1,1,1,1,1,1,1,1,
	1,0,0,1,1,0,0,1,
	0,1,1,0,0,1,1,0,
};

Tile wWall = { {
	1,1,1,1,1,1,1,1,
	1,1,1,1,1,1,1,1,
	1,1,1,1,1,1,1,1,
	0,0,0,0,0,0,0,0,
	1,1,1,1,1,1,1,1,
	1,1,1,1,1,1,1,1,
	1,1,1,1,1,1,1,1,
	0,0,0,0,0,0,0,0,}, 0b00000011 };

Tile cWall1 = { {
	1,1,1,1,1,1,1,1,
	1,1,1,1,1,1,0,1,
	1,1,1,1,1,0,1,1,
	1,1,1,1,1,1,1,1,
	1,1,1,1,1,1,1,1,
	1,1,0,1,1,1,1,1,
	1,0,1,1,1,1,1,1,
	1,1,1,1,1,1,1,1,}, 0b00000011 };

Tile cWall2 = { {
	1,1,1,1,1,1,1,1,
	1,1,1,1,1,0,1,1,
	1,1,1,1,0,1,1,1,
	1,1,1,1,1,1,1,1,
	1,1,1,1,1,1,1,1,
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
	1,1,1,1,1,1,1,1,}, 0b00000011 };

Tile bWall = { {
	0,1,0,0,0,0,0,0,
	0,1,0,0,0,0,0,0,
	1,1,1,1,1,1,1,1,
	0,0,0,0,0,1,0,0,
	0,0,0,0,0,1,0,0,
	0,0,0,0,0,1,0,0,
	1,1,1,1,1,1,1,1,
	0,1,0,0,0,0,0,0,}, 0b00100001 };

Tile Door = { {
	0,1,1,1,1,1,1,0,
	1,1,0,0,0,0,1,1,
	1,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,1,
	1,0,0,1,1,1,0,1,}, 0b00000001 };

Tile Door2 = { {
	1,0,0,0,0,1,0,1,
	1,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,1,
	1,0,0,0,0,0,0,1,
	1,1,0,0,0,0,1,1,
	1,1,1,1,1,1,1,1,}, 0b00000001 };

Sprite Stefan = {stefanvas, 8, 16};
Sprite FatherSam = { father, 8, 16 };
Tile tiles[16];
Game* scenes[2];
Entity player = { 128,40, 0, &Stefan };

unsigned char new_x = 12;
unsigned char new_y = 32;
unsigned char dir = 0b0001000;
unsigned char frame = 0;
unsigned char gamenum = 0;

unsigned char TileCol(Entity* entity, unsigned char tiletype) {
	unsigned char posx = (entity->x) / 8;
	unsigned short posy = (entity->y) / 8;
	posy *= 32;
	entity->colstat = 0;
	if (map[posx + posy] == tiletype) {
		entity->colstat |= 0b0001;
	}
	posx = (entity->x + entity->sprite->width / 2) / 8;
	posy = (entity->y + entity->sprite->height /2) / 8;
	posy *= 32;
	if (map[posx + posy] == tiletype) {
		entity->colstat |= 0b0010;
	}
	return entity->colstat;
}

void walking(void) {
	RemoveSprite(*player.sprite, player.x, player.y);

	player.x += 8 * GetKey(Right);
	player.x -= 8 * GetKey(Left);
	player.y += 8 * GetKey(Down);
	player.y -= 8 * GetKey(Up);

	SetSprite(*player.sprite, player.x, player.y, 15);

}

TimeEvent walkframe = { 6, walking };

void setup() {
	frame = 0;
	tiles[1] = cWall1;
	tiles[2] = cWall2;
	tiles[3] = Door;
	tiles[4] = Door2;

	
	map = new_designate_array(unsigned char, 32 * 24,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
		1,1,1,3,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,3,1,1,
		2,2,2,4,2,2,2,2,2,2,2,2,4,2,2,2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,2,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,1,
		2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,2,
);
	unsigned short sum = 0;
	for (int y = 0; y < 24; y++) {
		for (int x = 0; x < 32; x++) {
			SetTile(tiles[map[sum]], x, y);
			sum++;
		}
	}
	SetBGColour(3, 13, 3);
	SetBGColour(3, 14, 3);

	SetBGColour(12, 13, 14);
	SetBGColour(12, 14, 14);

	SetBGColour(21, 13, 3);
	SetBGColour(21, 14, 3);

	SetBGColour(29, 13, 3);
	SetBGColour(29, 14, 3);

	SetBGColour(30, 22, 14);
	SetBGColour(30, 23, 14);
}

void UpdatePlayer() {

	RunTimeEvent(&walkframe);

}

void loop() {
	UpdatePlayer();
	if (player.x == 240 && player.y == 168) {
		gamenum++;
		gamenum &= 1;
		ResetWindow();
	}
	if (GetKeyPressed(LeftControl)) {
		printf("%d, %d\n", player.x, player.y);
	}
}

void setuptoo() {
	SetPixel(4, 4, 4);
}

void looptoo() {
	UpdatePlayer();
	if (GetKeyPressed(Escape)) {
		gamenum++;
		gamenum &= 1;
		ResetWindow();
	}
	SetSprite(FatherSam, 128, 96, 8);
}

int main(void) {
	Game* fungame = newGame(setup, loop);
	Game* stupidgame = newGame(setuptoo, looptoo);
	
	scenes[0] = fungame;
	scenes[1] = stupidgame;

	CreateWindow();

	while (!CloseWindow()) {
		RunGame(scenes[gamenum]);
	}


	return 0;
}